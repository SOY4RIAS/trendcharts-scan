<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeScan Terminal - Enhanced with Charts</title>
    
    <!-- Chart.js for beautiful charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #121826;
            --bg-tertiary: #1a2332;
            --accent-green: #00ff88;
            --accent-red: #ff4466;
            --accent-blue: #4488ff;
            --accent-yellow: #ffbb33;
            --text-primary: #e8edf2;
            --text-secondary: #8b95a8;
            --border: #2a3544;
            --shadow: rgba(0, 0, 0, 0.4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        .grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            z-index: -1;
            animation: gridPulse 20s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.4; }
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-green);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 20px;
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-badge {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid var(--accent-green);
        }
        
        .market-status {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .status-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .status-value.positive { color: var(--accent-green); }
        .status-value.negative { color: var(--accent-red); }
        
        .container {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .control-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        input, select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: var(--bg-primary);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'IBM Plex Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .stock-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--accent-green);
        }
        
        .stock-card.buy-signal {
            border-left: 4px solid var(--accent-green);
        }
        
        .stock-card.sell-signal {
            border-left: 4px solid var(--accent-red);
        }
        
        .stock-card.neutral-signal {
            border-left: 4px solid var(--accent-yellow);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .stock-ticker {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stock-signal {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .signal-buy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .signal-sell {
            background: rgba(255, 68, 102, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .signal-hold {
            background: rgba(255, 187, 51, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }
        
        .stock-price {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .price-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .price-change.positive { color: var(--accent-green); }
        .price-change.negative { color: var(--accent-red); }
        
        /* Chart Container */
        .chart-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            position: relative;
            height: 320px; /* Increased from 250px for better visibility */
        }
        
        .chart-helper-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 0.5rem;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            padding: 0.25rem;
            background: rgba(42, 53, 68, 0.3);
            border-radius: 4px;
        }
        
        .chart-helper-text.hidden {
            display: none;
        }
        
        .chart-controls-hint {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            margin-top: 0.25rem;
            opacity: 0.6;
            font-style: italic;
        }
        
        /* Trend badge styling */
        .trend-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 10;
            backdrop-filter: blur(4px);
        }
        
        .trend-badge.uptrend {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
            border: 1.5px solid var(--accent-green);
        }
        
        .trend-badge.neutral {
            background: rgba(255, 187, 51, 0.15);
            color: var(--accent-yellow);
            border: 1.5px solid var(--accent-yellow);
        }
        
        .trend-badge.downtrend {
            background: rgba(255, 68, 102, 0.15);
            color: var(--accent-red);
            border: 1.5px solid var(--accent-red);
        }
        
        /* Chart popup modal */
        .chart-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .chart-popup.active {
            display: flex;
        }
        
        .chart-popup-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            width: 95%;
            max-width: 1600px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .chart-popup-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }
        
        .chart-popup-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .chart-popup-close {
            background: var(--accent-red);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .chart-popup-close:hover {
            background: #ff6688;
            transform: scale(1.05);
        }
        
        .chart-popup-body {
            flex: 1;
            display: flex;
            gap: 0;
            overflow: hidden;
        }
        
        .popup-left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            overflow-y: auto;
        }
        
        .popup-right-panel {
            width: 320px;
            background: var(--bg-tertiary);
            border-left: 2px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .popup-chart-wrapper {
            flex: 1;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }
        
        .popup-chart-container {
            flex: 1;
            position: relative;
            min-height: 450px;
        }
        
        .popup-toolbar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        .popup-tool-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1.5px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .popup-tool-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
        }
        
        .popup-tool-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .popup-tool-btn.reset {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }
        
        .popup-tool-btn.reset:hover {
            background: #ff6688;
        }
        
        .popup-timeframe-group {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 6px;
        }
        
        .popup-timeframe-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .popup-timeframe-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .popup-timeframe-btn.active {
            background: var(--accent-green);
            color: white;
        }
        
        .popup-section {
            margin-bottom: 1.5rem;
        }
        
        .popup-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popup-zones {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .popup-zone {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .popup-zone.entry {
            border-color: var(--accent-green);
        }
        
        .popup-zone.stop {
            border-color: var(--accent-red);
        }
        
        .popup-zone.target {
            border-color: var(--accent-blue);
        }
        
        .popup-zone-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popup-zone-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }
        
        .popup-zone-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .popup-indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .popup-indicator {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
        }
        
        .popup-indicator-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .popup-indicator-value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .popup-notes {
            margin-top: 1.5rem;
        }
        
        .popup-notes-textarea {
            width: 100%;
            min-height: 100px;
            background: var(--bg-secondary);
            border: 1.5px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.85rem;
            resize: vertical;
        }
        
        .popup-notes-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .popup-annotations {
            margin-top: 1rem;
        }
        
        .popup-annotation-item {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .popup-annotation-delete {
            background: transparent;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .popup-annotation-delete:hover {
            background: var(--accent-red);
            color: white;
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .chart-loading-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        canvas {
            max-height: 230px;
        }
        
        /* Range Selector */
        .range-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            justify-content: center;
        }
        
        .range-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .range-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        
        .range-btn.active {
            background: var(--accent-green);
            color: var(--bg-primary);
            border-color: var(--accent-green);
        }
        
        .indicators {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .indicator {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .indicator-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .indicator-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .trade-levels {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .trade-levels h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }
        
        .level-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        
        .level-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .level-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .level-entry { color: var(--accent-blue); }
        .level-stop { color: var(--accent-red); }
        .level-target { color: var(--accent-green); }
        
        .setup-description {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .error-message {
            background: rgba(255, 68, 102, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--accent-red);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 1rem;
        }
        
        .score-excellent {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .score-good {
            background: rgba(68, 136, 255, 0.2);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
        }
        
        .score-moderate {
            background: rgba(255, 187, 51, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }
        
        .score-poor {
            background: rgba(255, 68, 102, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .market-status {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="grid-background"></div>
    
    <header class="header">
        <div class="logo">
            <div class="logo-icon">TS</div>
            <div>
                <h1>TradeScan Terminal</h1>
            </div>
            <div class="logo-badge">Charts</div>
        </div>
        <div class="market-status">
            <div class="status-item">
                <div class="status-label">SPY</div>
                <div class="status-value" id="spy-price">--</div>
            </div>
            <div class="status-item">
                <div class="status-label">VIX</div>
                <div class="status-value" id="vix-price">--</div>
            </div>
            <div class="status-item">
                <div class="status-label">Time</div>
                <div class="status-value" id="current-time">--:--</div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="control-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Watchlist</label>
                    <select id="watchlist">
                        <option value="tech">Tech Giants (AAPL, MSFT, NVDA, AMD, GOOGL)</option>
                        <option value="finance">Finance (JPM, BAC, GS, MS, WFC)</option>
                        <option value="healthcare">Healthcare (JNJ, UNH, PFE, ABBV, LLY)</option>
                        <option value="consumer">Consumer (WMT, COST, HD, NKE, MCD)</option>
                        <option value="custom">Custom Tickers</option>
                    </select>
                </div>
                
                <div class="control-group" id="custom-tickers-group" style="display: none;">
                    <label class="control-label">Custom Tickers</label>
                    <input type="text" id="custom-tickers" placeholder="AAPL, MSFT, TSLA...">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Min R:R Ratio</label>
                    <select id="min-rr">
                        <option value="2">2:1 (Moderate)</option>
                        <option value="3" selected>3:1 (Conservative)</option>
                        <option value="4">4:1 (Very Conservative)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Account Size</label>
                    <input type="number" id="account-size" placeholder="2000" value="2000" min="100" step="100">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Risk % per Trade</label>
                    <input type="number" id="risk-percent" placeholder="0.5" value="0.5" min="0.1" max="5" step="0.1">
                </div>
            </div>
            
            <button id="scan-btn" onclick="scanStocks()">
                üéØ Scan for Opportunities
            </button>
        </div>
        
        <div id="results-container"></div>
    </div>
    
    <script>
        // Configuration
        const WATCHLISTS = {
            tech: ['AAPL', 'MSFT', 'NVDA', 'AMD', 'GOOGL'],
            finance: ['JPM', 'BAC', 'GS', 'MS', 'WFC'],
            healthcare: ['JNJ', 'UNH', 'PFE', 'ABBV', 'LLY'],
            consumer: ['WMT', 'COST', 'HD', 'NKE', 'MCD']
        };
        
        // Store charts for cleanup
        const chartInstances = {};
        
        // Update time
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('current-time').textContent = time;
        }
        
        setInterval(updateTime, 1000);
        updateTime();
        
        // Toggle custom tickers input
        document.getElementById('watchlist').addEventListener('change', function(e) {
            const customGroup = document.getElementById('custom-tickers-group');
            customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
        
        // Generate realistic simulated historical data
        function generateHistoricalData(currentPrice, days) {
            const data = [];
            let price = currentPrice * 0.85; // Start 15% lower
            const volatility = currentPrice * 0.02; // 2% daily volatility
            
            for (let i = 0; i < days; i++) {
                const change = (Math.random() - 0.48) * volatility; // Slight upward bias
                price += change;
                price = Math.max(price, currentPrice * 0.70); // Floor at 30% below
                price = Math.min(price, currentPrice * 1.15); // Cap at 15% above
                
                data.push({
                    date: new Date(Date.now() - (days - i) * 24 * 60 * 60 * 1000),
                    open: price,
                    high: price * (1 + Math.random() * 0.02),
                    low: price * (1 - Math.random() * 0.02),
                    close: price,
                    volume: Math.floor(Math.random() * 50000000) + 10000000
                });
            }
            
            return data;
        }
        
        // Fetch historical chart data
        async function fetchChartData(ticker, range = '1mo') {
            const rangeMap = {
                '5d': 5,
                '1mo': 30,
                '3mo': 90,
                '6mo': 180,
                '1y': 365
            };
            
            try {
                // Try to fetch real data from Yahoo Finance
                const interval = range === '5d' ? '1h' : '1d';
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=${range}&interval=${interval}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    
                    return timestamps.map((ts, i) => ({
                        date: new Date(ts * 1000),
                        open: quotes.open[i],
                        high: quotes.high[i],
                        low: quotes.low[i],
                        close: quotes.close[i],
                        volume: quotes.volume[i]
                    }));
                }
            } catch (error) {
                console.log(`Using simulated chart data for ${ticker}`);
            }
            
            // Fallback to simulated data
            const currentPrice = parseFloat(document.querySelector(`[data-ticker="${ticker}"]`)?.dataset.price || 100);
            return generateHistoricalData(currentPrice, rangeMap[range] || 30);
        }
        
        // Create candlestick-style chart
        async function createChart(ticker, containerId, range = '1mo') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Show loading
            container.innerHTML = `
                <div class="chart-loading">
                    <div class="chart-spinner"></div>
                    <div class="chart-loading-text">Loading ${range} chart...</div>
                </div>
            `;
            
            try {
                // Get current MA values from the stock card
                const stockCard = container.closest('.stock-card');
                const currentMA50 = parseFloat(stockCard?.dataset.ma50 || 100);
                const currentMA200 = parseFloat(stockCard?.dataset.ma200 || 95);
                
                // Fetch data
                const chartData = await fetchChartData(ticker, range);
                
                // Prepare data for Chart.js
                const labels = chartData.map(d => d.date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                const closes = chartData.map(d => d.close);
                const highs = chartData.map(d => d.high);
                const lows = chartData.map(d => d.low);
                const currentPrice = closes[closes.length - 1]; // Get last price for calculations
                
                // Calculate MA50 and MA200 for longer ranges
                const calculatedMA50 = calculateMA(closes, 50);
                const calculatedMA200 = calculateMA(closes, 200);
                
                // Smart MA display logic
                const dataPoints = closes.length;
                let ma50Data, ma200Data, showMA200 = true;
                
                // MA50 logic
                if (dataPoints < 50) {
                    // Very short range (5d, 1mo): show current MA50 as reference
                    ma50Data = Array(dataPoints).fill(currentMA50);
                } else {
                    // Long enough: show calculated MA50
                    ma50Data = calculatedMA50;
                }
                
                // MA200 logic - more conservative
                if (dataPoints < 90) {
                    // Very short range (5d, 1mo, 3mo): show current MA200 as reference
                    ma200Data = Array(dataPoints).fill(currentMA200);
                } else if (dataPoints < 200) {
                    // Mid range (6mo): NOT enough data to calculate, hide it
                    showMA200 = false;
                    ma200Data = [];
                } else {
                    // Long range (1y+): show calculated MA200
                    ma200Data = calculatedMA200;
                }
                
                // Clear loading and create canvas with trend badge
                const priceAboveMA50 = currentPrice > currentMA50;
                const priceAboveMA200 = currentPrice > currentMA200;
                
                let trendClass = 'neutral';
                let trendText = '‚ö†Ô∏è NEUTRAL';
                if (priceAboveMA50 && priceAboveMA200) {
                    trendClass = 'uptrend';
                    trendText = 'üìà STRONG UPTREND';
                } else if (!priceAboveMA200) {
                    trendClass = 'downtrend';
                    trendText = 'üìâ DOWNTREND';
                }
                
                let helperText = '';
                if (dataPoints < 50) {
                    helperText = `üí° MA50 at $${currentMA50.toFixed(2)} & MA200 at $${currentMA200.toFixed(2)} shown as reference lines`;
                } else if (dataPoints < 90) {
                    helperText = `üí° MA200 at $${currentMA200.toFixed(2)} shown as reference line`;
                } else if (dataPoints < 200) {
                    helperText = '‚ö†Ô∏è MA200 hidden - not enough data (switch to 1Y range to see MA200)';
                } else {
                    helperText = '‚úÖ Both MAs calculated from historical data';
                }
                
                container.innerHTML = `
                    <button class="chart-expand-btn" onclick="openChartPopup('${ticker}', '${range}')">
                        üîç Expand Chart
                    </button>
                    <div class="trend-badge ${trendClass}">${trendText}</div>
                    <canvas id="chart-${ticker}-${range}"></canvas>
                    ${helperText ? `<div class="chart-helper-text">${helperText}</div>` : ''}
                    <div class="chart-controls-hint">üí° Scroll to zoom ‚Ä¢ Ctrl+Drag to pan ‚Ä¢ Click üîç to expand</div>
                `;
                const canvas = document.getElementById(`chart-${ticker}-${range}`);
                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart if any
                const chartKey = `${ticker}-${range}`;
                if (chartInstances[chartKey]) {
                    chartInstances[chartKey].destroy();
                }
                
                // Build datasets array
                const datasets = [
                    {
                        label: 'Price',
                        data: closes,
                        borderColor: '#4488ff',
                        backgroundColor: 'rgba(68, 136, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    },
                    {
                        label: dataPoints < 50 ? 'MA50 (Reference)' : 'MA50',
                        data: ma50Data,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.05)',
                        borderWidth: dataPoints < 50 ? 2 : 1.5,
                        borderDash: dataPoints < 50 ? [10, 5] : [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }
                ];
                
                // Only add MA200 if we have enough data
                if (showMA200) {
                    datasets.push({
                        label: dataPoints < 90 ? 'MA200 (Reference)' : 'MA200',
                        data: ma200Data,
                        borderColor: '#ff4466',
                        backgroundColor: 'rgba(255, 68, 102, 0.05)',
                        borderWidth: dataPoints < 90 ? 2 : 1.5,
                        borderDash: dataPoints < 90 ? [10, 5] : [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    });
                }
                
                // Create chart with annotations
                chartInstances[chartKey] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#8b95a8',
                                    font: {
                                        family: 'JetBrains Mono',
                                        size: 10
                                    },
                                    boxWidth: 15,
                                    padding: 12,
                                    generateLabels: function(chart) {
                                        const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                        const labels = original.call(this, chart);
                                        
                                        // Customize labels for better clarity
                                        labels.forEach((label, i) => {
                                            if (i === 1) {  // MA50
                                                if (dataPoints < 50) {
                                                    label.text = `MA50: $${currentMA50.toFixed(2)} (Entry Support)`;
                                                } else {
                                                    label.text = `MA50 (Entry Support)`;
                                                }
                                            } else if (i === 2 && showMA200) {  // MA200
                                                if (dataPoints < 90) {
                                                    label.text = `MA200: $${currentMA200.toFixed(2)} (Major Support)`;
                                                } else {
                                                    label.text = `MA200 (Major Support)`;
                                                }
                                            }
                                        });
                                        
                                        return labels;
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: '#121826',
                                titleColor: '#e8edf2',
                                bodyColor: '#8b95a8',
                                borderColor: '#2a3544',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (context.parsed.y !== null) {
                                            label += ': $' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    },
                                    afterBody: function(tooltipItems) {
                                        // Add trading context
                                        const priceItem = tooltipItems.find(item => item.dataset.label === 'Price');
                                        if (!priceItem) return [];
                                        
                                        const price = priceItem.parsed.y;
                                        const ma50Value = currentMA50;
                                        const ma200Value = currentMA200;
                                        
                                        const lines = ['\nüìä Trading Context:'];
                                        
                                        // Price position vs MAs
                                        if (price > ma50Value && price > ma200Value) {
                                            const distanceMA50 = ((price - ma50Value) / ma50Value * 100).toFixed(1);
                                            lines.push(`‚úÖ Above both MAs (Strong uptrend)`);
                                            lines.push(`üìè ${distanceMA50}% above MA50`);
                                            if (Math.abs(price - ma50Value) / ma50Value < 0.03) {
                                                lines.push(`üéØ ENTRY ZONE - Near MA50 support`);
                                            }
                                        } else if (price > ma200Value) {
                                            lines.push(`‚ö†Ô∏è Above MA200, below MA50`);
                                            lines.push(`üîç Watch for MA50 reclaim`);
                                        } else {
                                            lines.push(`‚ùå Below MA200 - Downtrend`);
                                            lines.push(`üö´ Avoid long positions`);
                                        }
                                        
                                        return lines;
                                    },
                                    footer: function(tooltipItems) {
                                        if (dataPoints < 90 && showMA200) {
                                            return '\nüí° MA lines show current values';
                                        }
                                        return '';
                                    }
                                }
                            },
                            annotation: {
                                annotations: generateAnnotations(closes, currentMA50, currentMA200, dataPoints)
                            },
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                        speed: 0.1
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x'
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                    modifierKey: 'ctrl'
                                },
                                limits: {
                                    x: {min: 'original', max: 'original'}
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: '#2a3544',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#8b95a8',
                                    font: {
                                        family: 'JetBrains Mono',
                                        size: 9
                                    },
                                    maxRotation: 0,
                                    autoSkipPadding: 20
                                }
                            },
                            y: {
                                display: true,
                                position: 'right',
                                grid: {
                                    color: '#2a3544',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#8b95a8',
                                    font: {
                                        family: 'JetBrains Mono',
                                        size: 9
                                    },
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                container.innerHTML = `
                    <div class="chart-loading">
                        <div class="chart-loading-text" style="color: var(--accent-red);">
                            ‚ö†Ô∏è Chart load failed
                        </div>
                    </div>
                `;
            }
        }
        
        // Generate chart annotations for key trading zones
        function generateAnnotations(closes, ma50, ma200, dataPoints) {
            const annotations = {};
            const currentPrice = closes[closes.length - 1];
            
            if (!currentPrice || !ma50) return annotations;
            
            // Calculate positions
            const priceAboveMA50 = currentPrice > ma50;
            const priceAboveMA200 = currentPrice > ma200;
            const distanceFromMA50Percent = Math.abs((currentPrice - ma50) / ma50) * 100;
            
            // Only show annotations in uptrend
            if (priceAboveMA50 && priceAboveMA200) {
                
                // GREEN ENTRY ZONE: When price is within 5% of MA50
                if (distanceFromMA50Percent <= 5) {
                    const entryZoneTop = ma50 * 1.025;  // 2.5% above MA50
                    const entryZoneBottom = ma50 * 0.975;  // 2.5% below MA50
                    
                    // Entry zone box (shaded area)
                    annotations.entryZoneBox = {
                        type: 'box',
                        xMin: 0,
                        xMax: closes.length - 1,
                        yMin: entryZoneBottom,
                        yMax: entryZoneTop,
                        backgroundColor: 'rgba(0, 255, 136, 0.05)',
                        borderWidth: 0,
                        drawTime: 'beforeDatasetsDraw'
                    };
                    
                    // Entry zone border (top)
                    annotations.entryZoneTop = {
                        type: 'line',
                        yMin: entryZoneTop,
                        yMax: entryZoneTop,
                        borderColor: 'rgba(0, 255, 136, 0.4)',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        drawTime: 'beforeDatasetsDraw'
                    };
                    
                    // Entry zone border (bottom)
                    annotations.entryZoneBottom = {
                        type: 'line',
                        yMin: entryZoneBottom,
                        yMax: entryZoneBottom,
                        borderColor: 'rgba(0, 255, 136, 0.4)',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        drawTime: 'beforeDatasetsDraw'
                    };
                }
                
                // RED STOP LOSS ZONE: 2-3% below MA50
                const stopZoneTop = ma50 * 0.98;  // 2% below MA50
                const stopZoneBottom = ma50 * 0.97;  // 3% below MA50
                
                // Stop zone box (shaded area)
                annotations.stopZoneBox = {
                    type: 'box',
                    xMin: 0,
                    xMax: closes.length - 1,
                    yMin: stopZoneBottom,
                    yMax: stopZoneTop,
                    backgroundColor: 'rgba(255, 68, 102, 0.05)',
                    borderWidth: 0,
                    drawTime: 'beforeDatasetsDraw'
                };
                
                // Stop zone border (top)
                annotations.stopZoneTop = {
                    type: 'line',
                    yMin: stopZoneTop,
                    yMax: stopZoneTop,
                    borderColor: 'rgba(255, 68, 102, 0.4)',
                    borderWidth: 2,
                    borderDash: [6, 3],
                    drawTime: 'beforeDatasetsDraw'
                };
                
                // Stop zone border (bottom)
                annotations.stopZoneBottom = {
                    type: 'line',
                    yMin: stopZoneBottom,
                    yMax: stopZoneBottom,
                    borderColor: 'rgba(255, 68, 102, 0.4)',
                    borderWidth: 2,
                    borderDash: [6, 3],
                    drawTime: 'beforeDatasetsDraw'
                };
            }
            
            return annotations;
        }
        
        // Calculate moving average
        function calculateMA(data, period) {
            const ma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
            }
            return ma;
        }
        
        // Generate realistic simulated stock data
        function generateSimulatedData(ticker) {
            const basePrice = Math.random() * 250 + 50;
            const change = (Math.random() - 0.5) * 10;
            const changePercent = (change / basePrice) * 100;
            const volume = Math.floor(Math.random() * 45000000) + 5000000;
            const avgVolume = Math.floor(Math.random() * 45000000) + 5000000;
            const ma50 = basePrice * (0.95 + Math.random() * 0.10);
            const ma200 = basePrice * (0.90 + Math.random() * 0.20);
            const high52 = basePrice * 1.3;
            const low52 = basePrice * 0.7;
            
            return {
                ticker,
                price: parseFloat(basePrice.toFixed(2)),
                change: parseFloat(change.toFixed(2)),
                changePercent: parseFloat(changePercent.toFixed(2)),
                volume,
                avgVolume,
                ma50: parseFloat(ma50.toFixed(2)),
                ma200: parseFloat(ma200.toFixed(2)),
                high52: parseFloat(high52.toFixed(2)),
                low52: parseFloat(low52.toFixed(2))
            };
        }
        
        // Fetch stock data
        async function fetchStockData(ticker) {
            try {
                const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${ticker}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.quoteResponse && data.quoteResponse.result && data.quoteResponse.result.length > 0) {
                    const quote = data.quoteResponse.result[0];
                    return {
                        ticker,
                        price: quote.regularMarketPrice || 100,
                        change: quote.regularMarketChange || 0,
                        changePercent: quote.regularMarketChangePercent || 0,
                        volume: quote.regularMarketVolume || 1000000,
                        avgVolume: quote.averageDailyVolume10Day || 1000000,
                        ma50: quote.fiftyDayAverage || 100,
                        ma200: quote.twoHundredDayAverage || 95,
                        high52: quote.fiftyTwoWeekHigh || 150,
                        low52: quote.fiftyTwoWeekLow || 50
                    };
                }
            } catch (error) {
                console.log(`Using simulated data for ${ticker}`);
            }
            
            return generateSimulatedData(ticker);
        }
        
        // Calculate technical indicators
        function calculateIndicators(data) {
            const price = data.price;
            const ma50 = data.ma50;
            const ma200 = data.ma200;
            const high52 = data.high52;
            const low52 = data.low52;
            
            let rsi = 50 + ((price - low52) / (high52 - low52) * 50 - 25);
            rsi = Math.max(0, Math.min(100, rsi));
            
            const above_ma50 = price > ma50;
            const above_ma200 = price > ma200;
            const trend_strength = (above_ma50 ? 50 : 0) + (above_ma200 ? 50 : 0);
            const volume_ratio = data.avgVolume > 0 ? data.volume / data.avgVolume : 1.0;
            const distance_ma50 = ma50 > 0 ? ((price - ma50) / ma50) * 100 : 0;
            const distance_ma200 = ma200 > 0 ? ((price - ma200) / ma200) * 100 : 0;
            
            return {
                rsi: parseFloat(rsi.toFixed(1)),
                ma50,
                ma200,
                above_ma50,
                above_ma200,
                trend_strength,
                volume_ratio: parseFloat(volume_ratio.toFixed(2)),
                distance_ma50: parseFloat(distance_ma50.toFixed(2)),
                distance_ma200: parseFloat(distance_ma200.toFixed(2))
            };
        }
        
        // Determine trading setup
        function determineSetup(data, indicators) {
            if (indicators.above_ma50 && indicators.above_ma200) {
                if (indicators.distance_ma50 > -3 && indicators.distance_ma50 < 2) {
                    return {
                        type: 'Pullback',
                        description: 'Stock in uptrend pulling back to 50-day MA support. High probability bounce.',
                        confidence: 85
                    };
                }
            }
            
            if (indicators.volume_ratio > 1.5 && indicators.rsi > 50 && indicators.rsi < 70) {
                return {
                    type: 'Breakout',
                    description: 'Volume surge with momentum. Potential breakout from consolidation.',
                    confidence: 75
                };
            }
            
            if (indicators.above_ma200) {
                if (indicators.distance_ma200 > -2 && indicators.distance_ma200 < 5) {
                    return {
                        type: 'MA Bounce',
                        description: 'Testing 200-day MA in uptrend. Strong institutional support level.',
                        confidence: 80
                    };
                }
            }
            
            return {
                type: 'No Setup',
                description: 'No clear technical setup identified. Wait for better opportunity.',
                confidence: 40
            };
        }
        
        // Calculate trade levels
        function calculateTradeLevels(data, indicators, setup) {
            const price = data.price;
            let entry, stop, target;
            
            if (setup.type === 'Pullback') {
                entry = price;
                stop = Math.max(indicators.ma50 * 0.98, price * 0.97);
                target = price * 1.09;
            } else if (setup.type === 'Breakout') {
                entry = price;
                stop = price * 0.97;
                target = price * 1.09;
            } else if (setup.type === 'MA Bounce') {
                entry = price;
                stop = indicators.ma200 * 0.98;
                target = price * 1.08;
            } else {
                entry = price;
                stop = price * 0.98;
                target = price * 1.06;
            }
            
            const risk_per_share = entry - stop;
            const reward_per_share = target - entry;
            
            return {
                entry: parseFloat(entry.toFixed(2)),
                stop: parseFloat(stop.toFixed(2)),
                target: parseFloat(target.toFixed(2)),
                risk_per_share: parseFloat(risk_per_share.toFixed(2)),
                reward_per_share: parseFloat(reward_per_share.toFixed(2))
            };
        }
        
        // Calculate position size
        function calculatePositionSize(levels, accountSize, riskPercent) {
            const risk_amount = accountSize * (riskPercent / 100);
            const risk_per_share = levels.risk_per_share;
            
            if (risk_per_share <= 0) return null;
            
            const shares = Math.floor(risk_amount / risk_per_share);
            const position_size = shares * levels.entry;
            const rr_ratio = risk_per_share > 0 ? levels.reward_per_share / risk_per_share : 0;
            const potential_reward = shares * levels.reward_per_share;
            
            return {
                shares,
                position_size: parseFloat(position_size.toFixed(2)),
                actual_risk: parseFloat(risk_amount.toFixed(2)),
                potential_reward: parseFloat(potential_reward.toFixed(2)),
                rr_ratio: parseFloat(rr_ratio.toFixed(2))
            };
        }
        
        // Calculate score
        function calculateScore(indicators, position, minRR) {
            let score = 0;
            score += indicators.trend_strength * 0.4;
            
            const rsi = indicators.rsi;
            if (rsi >= 40 && rsi <= 70) {
                score += 20;
            } else if (rsi >= 30 && rsi < 40) {
                score += 15;
            } else if (rsi > 70) {
                score += 5;
            }
            
            const vol_ratio = indicators.volume_ratio;
            if (vol_ratio >= 1.2) {
                score += 20;
            } else if (vol_ratio >= 1.0) {
                score += 15;
            } else {
                score += 10;
            }
            
            if (position) {
                const rr = position.rr_ratio;
                if (rr >= minRR + 1) {
                    score += 20;
                } else if (rr >= minRR) {
                    score += 15;
                } else if (rr >= minRR - 0.5) {
                    score += 10;
                } else {
                    score += 5;
                }
            }
            
            return Math.min(100, Math.round(score));
        }
        
        // Determine signal
        function determineSignal(score, position, minRR) {
            if (!position) return 'HOLD';
            const rr = position.rr_ratio;
            if (rr >= minRR && score >= 70) return 'BUY';
            else if (score < 40) return 'SELL';
            else return 'HOLD';
        }
        
        // Analyze stock
        async function analyzeStock(ticker, accountSize, riskPercent, minRR) {
            const data = await fetchStockData(ticker);
            if (!data) return null;
            
            const indicators = calculateIndicators(data);
            const setup = determineSetup(data, indicators);
            const levels = calculateTradeLevels(data, indicators, setup);
            const position = calculatePositionSize(levels, accountSize, riskPercent);
            const score = calculateScore(indicators, position, minRR);
            const signal = determineSignal(score, position, minRR);
            
            return {
                ticker,
                price: data.price,
                change: data.change,
                changePercent: data.changePercent,
                signal,
                score,
                setup,
                indicators,
                levels,
                position
            };
        }
        
        // Create stock card HTML with chart
        function createStockCard(stock, index) {
            const signalClass = stock.signal === 'BUY' ? 'buy-signal' : 
                               stock.signal === 'SELL' ? 'sell-signal' : 
                               'neutral-signal';
            
            const signalBadgeClass = stock.signal === 'BUY' ? 'signal-buy' : 
                                     stock.signal === 'SELL' ? 'signal-sell' : 
                                     'signal-hold';
            
            const changeClass = stock.change >= 0 ? 'positive' : 'negative';
            const changeSymbol = stock.change >= 0 ? '+' : '';
            
            let scoreClass = 'score-poor';
            if (stock.score >= 80) scoreClass = 'score-excellent';
            else if (stock.score >= 60) scoreClass = 'score-good';
            else if (stock.score >= 40) scoreClass = 'score-moderate';
            
            const chartId = `chart-container-${stock.ticker}-${index}`;
            
            const positionHTML = stock.position ? `
                <div class="level-item" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                    <span class="level-label">Position Size:</span>
                    <span class="level-value">${stock.position.shares} shares</span>
                </div>
                <div class="level-item">
                    <span class="level-label">Total Investment:</span>
                    <span class="level-value">$${stock.position.position_size.toFixed(2)}</span>
                </div>
                <div class="level-item">
                    <span class="level-label">Risk Amount:</span>
                    <span class="level-value level-stop">$${stock.position.actual_risk.toFixed(2)}</span>
                </div>
            ` : '';
            
            return `
                <div class="stock-card ${signalClass}" data-ticker="${stock.ticker}" data-price="${stock.price}" data-ma50="${stock.indicators.ma50}" data-ma200="${stock.indicators.ma200}">
                    <div class="stock-header">
                        <div class="stock-ticker">${stock.ticker}</div>
                        <div class="stock-signal ${signalBadgeClass}">${stock.signal}</div>
                    </div>
                    
                    <div class="stock-price">
                        <div class="price-value">$${stock.price.toFixed(2)}</div>
                        <div class="price-change ${changeClass}">
                            ${changeSymbol}${stock.change.toFixed(2)} (${changeSymbol}${stock.changePercent.toFixed(2)}%)
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="range-selector">
                            <button class="range-btn" onclick="changeChartRange('${stock.ticker}', '${chartId}', '5d', this)">5D</button>
                            <button class="range-btn active" onclick="changeChartRange('${stock.ticker}', '${chartId}', '1mo', this)">1M</button>
                            <button class="range-btn" onclick="changeChartRange('${stock.ticker}', '${chartId}', '3mo', this)">3M</button>
                            <button class="range-btn" onclick="changeChartRange('${stock.ticker}', '${chartId}', '6mo', this)">6M</button>
                            <button class="range-btn" onclick="changeChartRange('${stock.ticker}', '${chartId}', '1y', this)">1Y</button>
                        </div>
                        <div id="${chartId}">
                            <div class="chart-loading">
                                <div class="chart-spinner"></div>
                                <div class="chart-loading-text">Loading chart...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="indicators">
                        <div class="indicator">
                            <div class="indicator-label">RSI</div>
                            <div class="indicator-value">${stock.indicators.rsi.toFixed(1)}</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">Volume</div>
                            <div class="indicator-value">${stock.indicators.volume_ratio.toFixed(2)}x</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">Trend</div>
                            <div class="indicator-value">${stock.indicators.trend_strength}%</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">R:R Ratio</div>
                            <div class="indicator-value">${stock.position ? stock.position.rr_ratio.toFixed(2) : '0.00'}:1</div>
                        </div>
                    </div>
                    
                    <div class="trade-levels">
                        <h4>üìä Trade Levels</h4>
                        <div class="level-item">
                            <span class="level-label">Entry Price:</span>
                            <span class="level-value level-entry">$${stock.levels.entry.toFixed(2)}</span>
                        </div>
                        <div class="level-item">
                            <span class="level-label">Stop Loss:</span>
                            <span class="level-value level-stop">$${stock.levels.stop.toFixed(2)}</span>
                        </div>
                        <div class="level-item">
                            <span class="level-label">Target:</span>
                            <span class="level-value level-target">$${stock.levels.target.toFixed(2)}</span>
                        </div>
                        ${positionHTML}
                    </div>
                    
                    <div class="score-badge ${scoreClass}">
                        ‚≠ê Score: ${stock.score}/100
                    </div>
                    
                    <div class="setup-description">
                        <strong>${stock.setup.type}</strong> (${stock.setup.confidence}% confidence)<br>
                        ${stock.setup.description}
                    </div>
                </div>
            `;
        }
        
        // Change chart range
        function changeChartRange(ticker, chartId, range, button) {
            // Update active button
            const parent = button.parentElement;
            parent.querySelectorAll('.range-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Load new chart
            createChart(ticker, chartId, range);
        }
        
        // Main scanning function
        async function scanStocks() {
            const scanBtn = document.getElementById('scan-btn');
            const resultsContainer = document.getElementById('results-container');
            const watchlistSelect = document.getElementById('watchlist');
            const accountSize = parseFloat(document.getElementById('account-size').value);
            const riskPercent = parseFloat(document.getElementById('risk-percent').value);
            const minRR = parseFloat(document.getElementById('min-rr').value);
            
            let tickers;
            if (watchlistSelect.value === 'custom') {
                const customInput = document.getElementById('custom-tickers').value;
                tickers = customInput.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
                if (tickers.length === 0) {
                    alert('Please enter at least one ticker symbol');
                    return;
                }
            } else {
                tickers = WATCHLISTS[watchlistSelect.value];
            }
            
            // Clear existing charts
            Object.values(chartInstances).forEach(chart => chart.destroy());
            
            scanBtn.disabled = true;
            scanBtn.textContent = '‚è≥ Scanning...';
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Analyzing ${tickers.length} stocks...</div>
                </div>
            `;
            
            try {
                const analyses = [];
                
                for (const ticker of tickers) {
                    try {
                        const analysis = await analyzeStock(ticker, accountSize, riskPercent, minRR);
                        if (analysis) {
                            analyses.push(analysis);
                        }
                    } catch (error) {
                        console.error(`Error analyzing ${ticker}:`, error);
                    }
                }
                
                analyses.sort((a, b) => b.score - a.score);
                
                // Store globally for popup access
                window.scannedStocks = analyses;
                
                if (analyses.length > 0) {
                    const cardsHTML = '<div class="results-grid">' + 
                        analyses.map((stock, index) => createStockCard(stock, index)).join('') + 
                        '</div>';
                    resultsContainer.innerHTML = cardsHTML;
                    
                    // Load charts asynchronously
                    analyses.forEach((stock, index) => {
                        const chartId = `chart-container-${stock.ticker}-${index}`;
                        setTimeout(() => {
                            createChart(stock.ticker, chartId, '1mo');
                        }, index * 100); // Stagger chart loading
                    });
                } else {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">No trading opportunities found</div>
                            <p style="margin-top: 1rem; color: var(--text-secondary);">Try adjusting your filters or selecting a different watchlist</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        ‚ö†Ô∏è Error scanning stocks: ${error.message}
                    </div>
                `;
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = 'üéØ Scan for Opportunities';
            }
        }
        
        // Update market status
        async function updateMarketStatus() {
            try {
                const spyQuote = await fetchStockData('SPY');
                const vixQuote = await fetchStockData('^VIX');
                
                if (spyQuote) {
                    const spyEl = document.getElementById('spy-price');
                    spyEl.textContent = `$${spyQuote.price.toFixed(2)}`;
                    spyEl.className = spyQuote.change >= 0 ? 'status-value positive' : 'status-value negative';
                }
                
                if (vixQuote) {
                    const vixEl = document.getElementById('vix-price');
                    vixEl.textContent = vixQuote.price.toFixed(2);
                    vixEl.className = vixQuote.price < 20 ? 'status-value positive' : 'status-value negative';
                }
            } catch (error) {
                console.error('Error updating market status:', error);
            }
        }
        
        // Initialize
        updateMarketStatus();
        setInterval(updateMarketStatus, 60000);
    </script>
    <!-- Chart Popup Modal -->
    <div id="chartPopup" class="chart-popup">
        <div class="chart-popup-content">
            <div class="chart-popup-header">
                <div class="chart-popup-title" id="popupTitle">Chart Analysis</div>
                <button class="chart-popup-close" onclick="closeChartPopup()">‚úï</button>
            </div>
            <div class="chart-popup-body">
                <!-- Left Panel: Chart with Tools -->
                <div class="popup-left-panel">
                    <div class="popup-toolbar">
                        <!-- Timeframe Selector -->
                        <div class="popup-timeframe-group">
                            <button class="popup-timeframe-btn" onclick="changePopupTimeframe('5d', this)">5D</button>
                            <button class="popup-timeframe-btn active" onclick="changePopupTimeframe('1mo', this)">1M</button>
                            <button class="popup-timeframe-btn" onclick="changePopupTimeframe('3mo', this)">3M</button>
                            <button class="popup-timeframe-btn" onclick="changePopupTimeframe('6mo', this)">6M</button>
                            <button class="popup-timeframe-btn" onclick="changePopupTimeframe('1y', this)">1Y</button>
                        </div>
                        
                        <!-- Analysis Tools -->
                        <button class="popup-tool-btn" id="horizontalLineTool" onclick="activateTool('horizontal')">
                            <span>üìè</span> Horizontal Line
                        </button>
                        <button class="popup-tool-btn" id="trendLineTool" onclick="activateTool('trend')">
                            <span>üìê</span> Trend Line
                        </button>
                        <button class="popup-tool-btn" id="markerTool" onclick="activateTool('marker')">
                            <span>üìç</span> Price Marker
                        </button>
                        <button class="popup-tool-btn reset" onclick="clearAnnotations()">
                            <span>üóëÔ∏è</span> Clear All
                        </button>
                    </div>
                    
                    <div class="popup-chart-wrapper">
                        <div class="popup-chart-container">
                            <canvas id="popupChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel: Trading Info -->
                <div class="popup-right-panel">
                    <!-- Trading Zones -->
                    <div class="popup-section">
                        <div class="popup-section-title">üéØ Trading Zones</div>
                        <div class="popup-zones" id="popupZones"></div>
                    </div>
                    
                    <!-- Key Indicators -->
                    <div class="popup-section">
                        <div class="popup-section-title">üìä Key Metrics</div>
                        <div class="popup-indicators" id="popupIndicators"></div>
                    </div>
                    
                    <!-- Your Annotations -->
                    <div class="popup-section">
                        <div class="popup-section-title">üìù Your Analysis</div>
                        <div class="popup-annotations" id="popupAnnotationsList"></div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="popup-notes">
                        <div class="popup-section-title">üí≠ Trading Notes</div>
                        <textarea 
                            id="popupNotes" 
                            class="popup-notes-textarea" 
                            placeholder="Add your analysis notes here...&#10;&#10;Example:&#10;- Strong support at MA50&#10;- Volume increasing&#10;- Wait for confirmation"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let popupChartInstance = null;
        let currentPopupTicker = null;
        let currentPopupRange = '1mo';
        let activeTool = null;
        let userAnnotations = [];
        let clickPoints = [];
        
        function activateTool(toolName) {
            // Deactivate all tools
            document.querySelectorAll('.popup-tool-btn').forEach(btn => {
                if (!btn.classList.contains('reset')) {
                    btn.classList.remove('active');
                }
            });
            
            if (activeTool === toolName) {
                activeTool = null;
                return;
            }
            
            activeTool = toolName;
            const toolBtn = document.getElementById(toolName + 'LineTool') || document.getElementById('markerTool');
            if (toolBtn) {
                toolBtn.classList.add('active');
            }
            
            alert(`Click on the chart to add ${toolName === 'horizontal' ? 'horizontal line' : toolName === 'trend' ? 'trend line (click 2 points)' : 'price marker'}`);
        }
        
        function clearAnnotations() {
            userAnnotations = [];
            clickPoints = [];
            updateAnnotationsList();
            if (popupChartInstance) {
                refreshPopupChart();
            }
        }
        
        function updateAnnotationsList() {
            const list = document.getElementById('popupAnnotationsList');
            if (!list) return;
            
            if (userAnnotations.length === 0) {
                list.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-secondary); font-style: italic;">No annotations yet. Use tools above to mark key levels.</div>';
                return;
            }
            
            list.innerHTML = userAnnotations.map((ann, i) => `
                <div class="popup-annotation-item">
                    <span>${ann.label}: $${ann.value.toFixed(2)}</span>
                    <button class="popup-annotation-delete" onclick="deleteAnnotation(${i})">‚úï</button>
                </div>
            `).join('');
        }
        
        function deleteAnnotation(index) {
            userAnnotations.splice(index, 1);
            updateAnnotationsList();
            if (popupChartInstance) {
                refreshPopupChart();
            }
        }
        
        function changePopupTimeframe(range, button) {
            currentPopupRange = range;
            document.querySelectorAll('.popup-timeframe-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (currentPopupTicker) {
                refreshPopupChart();
            }
        }
        
        function refreshPopupChart() {
            if (!currentPopupTicker) return;
            createPopupChart(currentPopupTicker, currentPopupRange);
        }
        
        function createPopupChart(ticker, range) {
            const stockCard = document.querySelector(`[data-ticker="${ticker}"]`);
            if (!stockCard) return;
            
            const stock = window.scannedStocks?.find(s => s.ticker === ticker);
            if (!stock) return;
            
            const canvas = document.getElementById('popupChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (popupChartInstance) {
                popupChartInstance.destroy();
            }
            
            // Get existing chart data
            const chartContainerId = `chart-container-${ticker}-${window.scannedStocks.findIndex(s => s.ticker === ticker)}`;
            const existingChartKey = `${ticker}-${range}`;
            const existingChart = chartInstances[existingChartKey];
            
            if (!existingChart) {
                console.warn('Chart not found, loading...');
                return;
            }
            
            const data = JSON.parse(JSON.stringify(existingChart.data));
            const currentMA50 = parseFloat(stockCard?.dataset.ma50 || 100);
            const currentMA200 = parseFloat(stockCard?.dataset.ma200 || 95);
            
            // Add user annotations to chart
            const annotations = generateAnnotations(
                data.datasets[0].data, 
                currentMA50, 
                currentMA200, 
                data.labels.length
            );
            
            // Add user-drawn annotations
            userAnnotations.forEach((ann, i) => {
                annotations[`user_${i}`] = {
                    type: 'line',
                    yMin: ann.value,
                    yMax: ann.value,
                    borderColor: ann.color || '#ffbb33',
                    borderWidth: 2,
                    borderDash: ann.dashed ? [8, 4] : [],
                    label: {
                        display: true,
                        content: ann.label,
                        position: 'end',
                        backgroundColor: 'rgba(18, 24, 38, 0.9)',
                        color: ann.color || '#ffbb33',
                        font: {
                            size: 10,
                            family: 'JetBrains Mono'
                        },
                        padding: 4
                    }
                };
            });
            
            // Create enhanced popup chart
            popupChartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    ...existingChart.options,
                    maintainAspectRatio: false,
                    onClick: handleChartClick,
                    plugins: {
                        ...existingChart.options.plugins,
                        title: {
                            display: true,
                            text: `${ticker} - ${range.toUpperCase()} Price Action Analysis`,
                            color: '#e8edf2',
                            font: {
                                family: 'JetBrains Mono',
                                size: 16,
                                weight: 'bold'
                            },
                            padding: 15
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#8b95a8',
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 12
                                },
                                boxWidth: 15,
                                padding: 12
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        ...existingChart.options.scales,
                        y: {
                            ...existingChart.options.scales.y,
                            ticks: {
                                ...existingChart.options.scales.y.ticks,
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 11
                                }
                            }
                        },
                        x: {
                            ...existingChart.options.scales.x,
                            ticks: {
                                ...existingChart.options.scales.x.ticks,
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function handleChartClick(event) {
            if (!activeTool || !popupChartInstance) return;
            
            const canvasPosition = Chart.helpers.getRelativePosition(event, popupChartInstance);
            const dataX = popupChartInstance.scales.x.getValueForPixel(canvasPosition.x);
            const dataY = popupChartInstance.scales.y.getValueForPixel(canvasPosition.y);
            
            if (activeTool === 'horizontal') {
                userAnnotations.push({
                    type: 'horizontal',
                    value: dataY,
                    label: `Level: $${dataY.toFixed(2)}`,
                    color: '#ffbb33',
                    dashed: true
                });
                activeTool = null;
                document.getElementById('horizontalLineTool').classList.remove('active');
                updateAnnotationsList();
                refreshPopupChart();
            } else if (activeTool === 'marker') {
                userAnnotations.push({
                    type: 'marker',
                    value: dataY,
                    label: `üìç $${dataY.toFixed(2)}`,
                    color: '#4488ff',
                    dashed: false
                });
                activeTool = null;
                document.getElementById('markerTool').classList.remove('active');
                updateAnnotationsList();
                refreshPopupChart();
            } else if (activeTool === 'trend') {
                clickPoints.push({ x: dataX, y: dataY });
                if (clickPoints.length === 2) {
                    const [point1, point2] = clickPoints;
                    const slope = (point2.y - point1.y) / (point2.x - point1.x);
                    const direction = slope > 0 ? 'Uptrend' : 'Downtrend';
                    userAnnotations.push({
                        type: 'trend',
                        value: point1.y,
                        label: `${direction} Line`,
                        color: slope > 0 ? '#00ff88' : '#ff4466',
                        dashed: false,
                        points: clickPoints
                    });
                    clickPoints = [];
                    activeTool = null;
                    document.getElementById('trendLineTool').classList.remove('active');
                    updateAnnotationsList();
                    refreshPopupChart();
                }
            }
        }
        
        function openChartPopup(ticker, range) {
            const popup = document.getElementById('chartPopup');
            const title = document.getElementById('popupTitle');
            const stockCard = document.querySelector(`[data-ticker="${ticker}"]`);
            
            if (!stockCard) {
                console.error('Stock card not found');
                return;
            }
            
            const stock = window.scannedStocks?.find(s => s.ticker === ticker);
            if (!stock) {
                console.error('Stock data not found');
                return;
            }
            
            currentPopupTicker = ticker;
            currentPopupRange = range;
            
            // Set title
            title.textContent = `${ticker} - Detailed Analysis`;
            
            // Populate trading zones
            const entry = stock.levels?.entry || stock.price;
            const stop = stock.levels?.stop || (stock.price * 0.97);
            const target = stock.levels?.target || (stock.price * 1.03);
            const riskPerShare = entry - stop;
            const rewardPerShare = target - entry;
            const rrRatio = stock.position?.rr_ratio || (rewardPerShare / riskPerShare);
            const riskPercent = ((riskPerShare / entry) * 100).toFixed(1);
            
            const zonesHTML = `
                <div class="popup-zone entry">
                    <div class="popup-zone-title">üéØ Entry Zone</div>
                    <div class="popup-zone-value" style="color: var(--accent-green)">$${entry.toFixed(2)}</div>
                    <div class="popup-zone-desc">Buy when price touches MA50 support at $${stock.indicators?.ma50?.toFixed(2) || 'N/A'}</div>
                </div>
                
                <div class="popup-zone stop">
                    <div class="popup-zone-title">üõë Stop Loss</div>
                    <div class="popup-zone-value" style="color: var(--accent-red)">$${stop.toFixed(2)}</div>
                    <div class="popup-zone-desc">Risk: $${riskPerShare.toFixed(2)}/share (${riskPercent}%)</div>
                </div>
                
                <div class="popup-zone target">
                    <div class="popup-zone-title">üéØ Target</div>
                    <div class="popup-zone-value" style="color: var(--accent-blue)">$${target.toFixed(2)}</div>
                    <div class="popup-zone-desc">Reward: $${rewardPerShare.toFixed(2)}/share ‚Ä¢ R:R ${rrRatio.toFixed(2)}:1</div>
                </div>
            `;
            document.getElementById('popupZones').innerHTML = zonesHTML;
            
            // Populate indicators
            const indicatorsHTML = `
                <div class="popup-indicator">
                    <div class="popup-indicator-label">RSI</div>
                    <div class="popup-indicator-value">${stock.indicators?.rsi?.toFixed(1) || 'N/A'}</div>
                </div>
                <div class="popup-indicator">
                    <div class="popup-indicator-label">Volume</div>
                    <div class="popup-indicator-value">${stock.indicators?.volume_ratio?.toFixed(2) || 'N/A'}x</div>
                </div>
                <div class="popup-indicator">
                    <div class="popup-indicator-label">Trend</div>
                    <div class="popup-indicator-value">${stock.indicators?.trend_strength || 'N/A'}%</div>
                </div>
                <div class="popup-indicator">
                    <div class="popup-indicator-label">Score</div>
                    <div class="popup-indicator-value" style="color: ${stock.score >= 70 ? 'var(--accent-green)' : stock.score >= 40 ? 'var(--accent-yellow)' : 'var(--accent-red)'}">${stock.score}/100</div>
                </div>
                <div class="popup-indicator">
                    <div class="popup-indicator-label">Signal</div>
                    <div class="popup-indicator-value" style="color: ${stock.signal === 'BUY' ? 'var(--accent-green)' : stock.signal === 'SELL' ? 'var(--accent-red)' : 'var(--accent-yellow)'}">${stock.signal}</div>
                </div>
                <div class="popup-indicator">
                    <div class="popup-indicator-label">Setup</div>
                    <div class="popup-indicator-value" style="font-size: 0.85rem;">${stock.setup?.type || 'None'}</div>
                </div>
            `;
            document.getElementById('popupIndicators').innerHTML = indicatorsHTML;
            
            // Reset annotations
            updateAnnotationsList();
            
            // Clear notes
            document.getElementById('popupNotes').value = '';
            
            // Show popup
            popup.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Create chart
            setTimeout(() => {
                createPopupChart(ticker, range);
            }, 100);
        }
        
        function closeChartPopup() {
            const popup = document.getElementById('chartPopup');
            popup.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            if (popupChartInstance) {
                popupChartInstance.destroy();
                popupChartInstance = null;
            }
        }
        
        // Close popup on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeChartPopup();
            }
        });
        
        // Close popup on outside click
        document.getElementById('chartPopup')?.addEventListener('click', (e) => {
            if (e.target.id === 'chartPopup') {
                closeChartPopup();
            }
        });
    </script>
</body>
</html>
